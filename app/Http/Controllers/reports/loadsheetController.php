<?php
 namespace App\Http\Controllers\reports; use App\Http\Controllers\Controller; use App\Models\sales; use Illuminate\Http\Request; use App\Models\User; class loadsheetController extends Controller { public function index() { $orderbookers = User::all(); return view("\162\145\160\157\x72\x74\x73\x2e\x6c\x6f\141\144\x73\150\145\x65\x74\x2e\x69\156\144\145\x78", compact("\157\x72\x64\x65\x72\x62\157\x6f\153\x65\x72\x73")); } public function data($id, $date) { $sales = sales::whereDate("\x64\x61\x74\x65", $date)->where("\157\x72\144\145\x72\142\157\157\153\x65\x72\111\x44", $id)->with("\x64\x65\x74\141\151\x6c\163")->get(); if ($sales->isEmpty()) { return back()->with("\x65\x72\x72\157\162", "\116\x6f\40\x44\141\x74\x61\x20\x46\157\165\156\144"); } $salesData = array("\x73\x61\x6c\x65\137\x69\x6e\x66\157" => $sales->map->toArray(), "\163\141\154\145\137\144\145\164\x61\151\154\x73" => array(), "\164\157\164\x61\154\137\x73\x61\154\x65\137\141\155\157\165\156\164" => 0); $allProducts = array(); foreach ($sales as $sale) { $productSales = $sale->details->groupBy("\160\162\157\x64\165\x63\x74\x49\104"); foreach ($productSales as $productID => $saleDetails) { $totalQty = $saleDetails->sum("\161\x74\x79"); $totalAmount = $saleDetails->sum("\x74\x69"); if (!isset($allProducts[$productID])) { $product = $saleDetails->first()->product; $allProducts[$productID] = array("\x70\162\157\x64\x75\x63\164\111\x44" => $productID, "\156\x61\155\x65" => $product->name, "\x63\141\x74" => $product->category->name, "\x74\x6f\x74\141\x6c\x5f\161\x74\171" => 0, "\x74\x6f\x74\x61\154\x5f\141\x6d\x6f\x75\156\164" => 0, "\x70\x61\143\153\137\163\151\172\x65" => $product->unit->value); } $allProducts[$productID]["\x74\157\164\x61\x6c\x5f\161\x74\171"] += $totalQty; $allProducts[$productID]["\x74\x6f\x74\x61\x6c\137\141\155\157\x75\x6e\164"] += $totalAmount; } $salesData["\x74\157\x74\x61\x6c\137\163\141\x6c\x65\137\141\155\x6f\165\156\x74"] += $sale->details->sum("\x74\x69"); $salesData["\157\162\144\145\x72\142\157\157\153\x65\x72"] = $sale->orderbooker->name; $salesData["\x64\141\x74\145"] = $sale->date; } $salesData["\x73\x61\x6c\x65\137\x64\145\x74\x61\x69\x6c\163"] = array_values($allProducts); return view("\x72\145\x70\157\162\164\x73\x2e\x6c\157\141\144\x73\x68\x65\x65\x74\x2e\x64\145\x74\x61\151\x6c\x73", compact("\163\x61\x6c\x65\163\x44\141\x74\x61")); } }